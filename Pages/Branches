import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import PageHeader from '../components/shared/PageHeader';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetFooter,
} from "@/components/ui/sheet";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { 
  MoreVertical, 
  Pencil, 
  Trash2, 
  Building2,
  MapPin,
  Phone,
  Clock,
  Users,
  Truck,
  Package
} from 'lucide-react';
import { toast } from "sonner";
import { cn } from "@/lib/utils";

export default function Branches() {
  const [showSheet, setShowSheet] = useState(false);
  const [editingBranch, setEditingBranch] = useState(null);
  const queryClient = useQueryClient();

  const { data: branches = [], isLoading } = useQuery({
    queryKey: ['branches'],
    queryFn: () => base44.entities.Branch.list(),
  });

  const { data: drivers = [] } = useQuery({
    queryKey: ['drivers'],
    queryFn: () => base44.entities.Driver.list(),
  });

  const { data: orders = [] } = useQuery({
    queryKey: ['orders'],
    queryFn: () => base44.entities.Order.list(),
  });

  const { data: products = [] } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list(),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Branch.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries(['branches']);
      toast.success('تم إضافة الفرع بنجاح');
      setShowSheet(false);
      setEditingBranch(null);
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Branch.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries(['branches']);
      toast.success('تم تحديث الفرع');
      setShowSheet(false);
      setEditingBranch(null);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Branch.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries(['branches']);
      toast.success('تم حذف الفرع');
    },
  });

  const getBranchStats = (branchId) => {
    const branchDrivers = drivers.filter(d => d.branch_id === branchId);
    const branchOrders = orders.filter(o => o.branch_id === branchId);
    const branchProducts = products.filter(p => p.branch_id === branchId);
    return {
      driversCount: branchDrivers.length,
      onlineDrivers: branchDrivers.filter(d => d.is_online).length,
      ordersCount: branchOrders.length,
      todayOrders: branchOrders.filter(o => 
        o.created_date?.startsWith(new Date().toISOString().split('T')[0])
      ).length,
      productsCount: branchProducts.length,
    };
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
      name: formData.get('name'),
      address: formData.get('address'),
      phone: formData.get('phone'),
      latitude: parseFloat(formData.get('latitude')) || null,
      longitude: parseFloat(formData.get('longitude')) || null,
      working_hours: formData.get('working_hours'),
      is_active: editingBranch?.is_active ?? true,
    };

    if (editingBranch) {
      updateMutation.mutate({ id: editingBranch.id, data });
    } else {
      createMutation.mutate(data);
    }
  };

  return (
    <div className="space-y-6">
      <PageHeader 
        title="الفروع"
        description={`${branches.length} فرع`}
        action={() => {
          setEditingBranch(null);
          setShowSheet(true);
        }}
        actionLabel="إضافة فرع"
      />

      {isLoading ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {[...Array(3)].map((_, i) => (
            <Card key={i} className="border-0 shadow-sm animate-pulse">
              <CardContent className="p-6">
                <div className="h-6 bg-slate-200 rounded w-2/3 mb-3" />
                <div className="h-4 bg-slate-200 rounded w-1/2" />
              </CardContent>
            </Card>
          ))}
        </div>
      ) : branches.length === 0 ? (
        <Card className="border-0 shadow-sm">
          <CardContent className="py-16 text-center text-slate-400">
            <Building2 className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p>لا توجد فروع</p>
            <Button className="mt-4" onClick={() => setShowSheet(true)}>
              إضافة أول فرع
            </Button>
          </CardContent>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {branches.map((branch) => {
            const stats = getBranchStats(branch.id);
            return (
              <Card 
                key={branch.id}
                className={cn(
                  "border-0 shadow-sm hover:shadow-md transition-all group",
                  !branch.is_active && "opacity-60"
                )}
              >
                <CardContent className="p-5">
                  <div className="flex items-start justify-between mb-4">
                    <div className={cn(
                      "w-12 h-12 rounded-xl flex items-center justify-center",
                      "bg-gradient-to-br from-violet-500 to-purple-600"
                    )}>
                      <Building2 className="w-6 h-6 text-white" />
                    </div>
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button 
                          variant="ghost" 
                          size="icon" 
                          className="h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <MoreVertical className="w-4 h-4" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuItem onClick={() => {
                          setEditingBranch(branch);
                          setShowSheet(true);
                        }}>
                          <Pencil className="w-4 h-4 ml-2" />
                          تعديل
                        </DropdownMenuItem>
                        <DropdownMenuItem onClick={() => {
                          updateMutation.mutate({ 
                            id: branch.id, 
                            data: { is_active: !branch.is_active } 
                          });
                        }}>
                          {branch.is_active ? 'إيقاف' : 'تفعيل'}
                        </DropdownMenuItem>
                        <DropdownMenuItem 
                          className="text-red-600"
                          onClick={() => deleteMutation.mutate(branch.id)}
                        >
                          <Trash2 className="w-4 h-4 ml-2" />
                          حذف
                        </DropdownMenuItem>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  </div>

                  <div className="flex items-center justify-between mb-2">
                    <h3 className="font-semibold text-slate-800">
                      {branch.name}
                    </h3>
                    {!branch.is_active && (
                      <Badge variant="outline" className="bg-red-50 text-red-600">
                        متوقف
                      </Badge>
                    )}
                  </div>

                  <div className="space-y-2 text-sm text-slate-500 mb-4">
                    {branch.address && (
                      <div className="flex items-start gap-2">
                        <MapPin className="w-4 h-4 mt-0.5 flex-shrink-0" />
                        <span>{branch.address}</span>
                      </div>
                    )}
                    {branch.phone && (
                      <div className="flex items-center gap-2">
                        <Phone className="w-4 h-4" />
                        <span dir="ltr">{branch.phone}</span>
                      </div>
                    )}
                    {branch.working_hours && (
                      <div className="flex items-center gap-2">
                        <Clock className="w-4 h-4" />
                        <span>{branch.working_hours}</span>
                      </div>
                    )}
                  </div>

                  <div className="grid grid-cols-3 gap-2 pt-3 border-t border-slate-100">
                    <div className="text-center">
                      <div className="flex items-center justify-center gap-1 text-cyan-600">
                        <Truck className="w-4 h-4" />
                        <span className="font-bold">{stats.driversCount}</span>
                      </div>
                      <span className="text-xs text-slate-400">سائق</span>
                    </div>
                    <div className="text-center">
                      <div className="flex items-center justify-center gap-1 text-emerald-600">
                        <Package className="w-4 h-4" />
                        <span className="font-bold">{stats.todayOrders}</span>
                      </div>
                      <span className="text-xs text-slate-400">طلب اليوم</span>
                    </div>
                    <div className="text-center">
                      <div className="flex items-center justify-center gap-1 text-purple-600">
                        <Users className="w-4 h-4" />
                        <span className="font-bold">{stats.onlineDrivers}</span>
                      </div>
                      <span className="text-xs text-slate-400">متصل</span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}

      {/* Add/Edit Sheet */}
      <Sheet open={showSheet} onOpenChange={setShowSheet}>
        <SheetContent side="left" className="w-full sm:max-w-lg overflow-y-auto" dir="rtl">
          <SheetHeader>
            <SheetTitle>
              {editingBranch ? 'تعديل الفرع' : 'إضافة فرع جديد'}
            </SheetTitle>
          </SheetHeader>
          <form onSubmit={handleSubmit} className="space-y-4 mt-6">
            <div className="space-y-2">
              <Label htmlFor="name">اسم الفرع</Label>
              <Input 
                id="name" 
                name="name" 
                defaultValue={editingBranch?.name}
                required 
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="address">العنوان</Label>
              <Input 
                id="address" 
                name="address"
                defaultValue={editingBranch?.address}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="phone">رقم الهاتف</Label>
              <Input 
                id="phone" 
                name="phone"
                defaultValue={editingBranch?.phone}
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="latitude">خط العرض</Label>
                <Input 
                  id="latitude" 
                  name="latitude"
                  type="number"
                  step="any"
                  defaultValue={editingBranch?.latitude}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="longitude">خط الطول</Label>
                <Input 
                  id="longitude" 
                  name="longitude"
                  type="number"
                  step="any"
                  defaultValue={editingBranch?.longitude}
                />
              </div>
            </div>
            <div className="space-y-2">
              <Label htmlFor="working_hours">ساعات العمل</Label>
              <Input 
                id="working_hours" 
                name="working_hours"
                placeholder="مثال: 9 ص - 11 م"
                defaultValue={editingBranch?.working_hours}
              />
            </div>
            <SheetFooter className="mt-6">
              <Button type="submit" className="w-full">
                {editingBranch ? 'حفظ التغييرات' : 'إضافة الفرع'}
              </Button>
            </SheetFooter>
          </form>
        </SheetContent>
      </Sheet>
    </div>
  );
}
